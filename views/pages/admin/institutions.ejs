<style>
    .table-responsive {
        overflow-x: auto;
    }
</style>
<div id="institutions" class="content-section active">
    <div class="page-header d-flex justify-content-between align-items-center">
        <div>
            <h2><i class="fas fa-building me-2"></i>Manajemen Institusi</h2>
            <p class="text-muted mb-0">Kelola data institusi</p>
        </div>
        <button class="btn btn-primary" onclick="showInstitutionModal()">
            <i class="fas fa-plus me-2"></i>Tambah Institusi
        </button>
    </div>

    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Daftar Institusi</h5>
        </div>
        <div class="card-body">
            <div id="errorMessage" class="alert alert-danger d-none"></div>
            <div id="successMessage" class="alert alert-success d-none"></div>
            <div class="div table-responsive">
            <table class="table table-striped table-hover" id="institutionsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nama Institusi</th>
                        <th>Tipe</th>
                        <th>Status</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Institution -->
<div class="modal fade" id="institutionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="institutionForm" onsubmit="event.preventDefault(); saveInstitution();">
                <div class="modal-header">
                    <h5 class="modal-title" id="institutionModalTitle">Tambah Institusi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="institutionId" />
                    <div id="errorMessageModal" class="alert alert-danger d-none"></div>
                    <div class="mb-3">
                        <label for="institutionType" class="form-label">Tipe</label>
                        <select class="form-select" id="institutionType" required>
                            <option value="">Pilih Tipe</option>
                            <option value="Internasional">Internasional</option>
                            <option value="Nasional">Nasional</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="institutionName" class="form-label">Nama Institusi</label>
                        <input type="text" class="form-control" id="institutionName" required />
                    </div>
                    <div class="mb-3">
                        <label for="institutionActive" class="form-label">Status</label>
                        <select class="form-select" id="institutionActive" required>
                            <option value="">Pilih Status</option>
                            <option value="aktif">Aktif</option>
                            <option value="nonaktif">Non-Aktif</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Jquery CDN -->
<script
 src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
 integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
 crossorigin="anonymous"
 referrerpolicy="no-referrer"></script>
<!-- DataTables CSS -->
<link
 rel="stylesheet"
 href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" />

<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

<script>
    let institutions = [];
    let dataTable;

    function renderDataTable() {
        // Destroy existing DataTable if it exists
        if (dataTable) {
            dataTable.destroy();
        }

        // Initialize DataTable
        dataTable = $("#institutionsTable").DataTable({
            data: institutions,
            columns: [
                { data: "id" },
                { data: "name" },
                {
                    data: "type",
                    render: function (data) {
                        const badgeColor = data === "Internasional" ? "primary" : "info";
                        return `<span class="badge bg-${badgeColor}">${data}</span>`;
                    },
                },
                {
                    data: "active",
                    render: function (data) {
                        return `<span class="badge bg-${data ? "success" : "danger"}">
                            ${data ? "Aktif" : "Non-Aktif"}
                        </span>`;
                    },
                },
                {
                    data: null,
                    render: function (data, type, row) {
                        return `
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editInstitution(${row.id})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteInstitution(${row.id})" title="Hapus">
                                <i class="fas fa-trash"></i>
                            </button>
                        `;
                    },
                    orderable: false,
                },
            ],
            order: [[0, "desc"]], // Sort by ID descending
            pageLength: 10,
            lengthMenu: [
                [5, 10, 25, 50, -1],
                [5, 10, 25, 50, "Semua"],
            ],
            language: {
                lengthMenu: "Tampilkan _MENU_ data per halaman",
                zeroRecords: "Data tidak ditemukan",
                info: "Menampilkan halaman _PAGE_ dari _PAGES_",
                infoEmpty: "Tidak ada data tersedia",
                infoFiltered: "(difilter dari _MAX_ total data)",
                search: "Cari:",
                paginate: {
                    first: "Pertama",
                    last: "Terakhir",
                    next: "Selanjutnya",
                    previous: "Sebelumnya",
                },
            },
            responsive: true,
            autoWidth: false,
        });
    }

    async function loadInstitutions() {
        institutions = await fetchInstitutions();
        renderDataTable();
    }

    async function fetchInstitutions() {
        try {
            const response = await fetch("/api/institutions");
            if (!response.ok) throw new Error("Network response was not ok");
            return await response.json();
        } catch (error) {
            console.error("Error fetching institutions:", error);
            return [];
        }
    }

    function showInstitutionModal(institutionId = null) {
        const modal = new bootstrap.Modal(document.getElementById("institutionModal"));
        const title = document.getElementById("institutionModalTitle");
        const form = document.getElementById("institutionForm");
        document.getElementById("errorMessageModal").classList.add("d-none");

        if (institutionId) {
            const institution = institutions.find((i) => i.id === institutionId);
            title.textContent = "Edit Institusi";
            document.getElementById("institutionId").value = institution.id;
            document.getElementById("institutionType").value = institution.type;
            document.getElementById("institutionName").value = institution.name;
            document.getElementById("institutionActive").value = institution.active ? "aktif" : "nonaktif";
        } else {
            title.textContent = "Tambah Institusi";
            form.reset();
            document.getElementById("institutionId").value = "";
        }

        modal.show();
    }

    function editInstitution(institutionId) {
        showInstitutionModal(institutionId);
    }

    async function saveInstitution() {
        const institutionId = document.getElementById("institutionId").value;
        const institutionData = {
            type: document.getElementById("institutionType").value.trim(),
            name: document.getElementById("institutionName").value.trim(),
            active: document.getElementById("institutionActive").value,
        };

        const invalidFields = Object.entries(institutionData).filter(([key, value]) => !value);
        if (invalidFields.length > 0) {
            const errorMessage = document.getElementById("errorMessageModal");
            errorMessage.textContent = `Field ${invalidFields
                .map(([key]) => key.replace("_", " "))
                .join(", ")} wajib diisi.`;
            errorMessage.classList.remove("d-none");
            return;
        }

        institutionData.active = institutionData.active === "aktif" ? true : false;

        try {
            const url = institutionId ? `/api/institutions/${institutionId}` : "/api/institutions";
            const method = institutionId ? "PUT" : "POST";

            const response = await fetch(url, {
                method: method,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(institutionData),
            });

            const json = await response.json();

            if (response.ok) {
                const successMessage = document.getElementById("successMessage");
                successMessage.textContent = institutionId
                    ? "Institusi berhasil diperbarui."
                    : "Institusi berhasil ditambahkan.";
                successMessage.classList.remove("d-none");
                setTimeout(() => successMessage.classList.add("d-none"), 5000);

                bootstrap.Modal.getInstance(document.getElementById("institutionModal")).hide();
                loadInstitutions();
            } else {
                const errorMessage = document.getElementById("errorMessageModal");
                errorMessage.textContent = json.message || "Terjadi kesalahan saat menyimpan institusi.";
                errorMessage.classList.remove("d-none");
            }
        } catch (error) {
            console.error("Error saving institution:", error);
            const errorMessage = document.getElementById("errorMessageModal");
            errorMessage.textContent = "Terjadi kesalahan saat menyimpan institusi.";
            errorMessage.classList.remove("d-none");
        }
    }

    async function deleteInstitution(institutionId) {
        const confirmDelete = confirm("Apakah Anda yakin ingin menghapus institusi ini?");
        if (!confirmDelete) return;

        try {
            const response = await fetch(`/api/institutions/${institutionId}`, {
                method: "DELETE",
            });

            if (response.ok) {
                const successMessage = document.getElementById("successMessage");
                successMessage.textContent = "Institusi berhasil dihapus.";
                successMessage.classList.remove("d-none");
                setTimeout(() => successMessage.classList.add("d-none"), 5000);
            } else {
                const json = await response.json();
                const errorMessage = document.getElementById("errorMessage");
                errorMessage.textContent = json.message || "Terjadi kesalahan saat menghapus institusi.";
                errorMessage.classList.remove("d-none");
                setTimeout(() => errorMessage.classList.add("d-none"), 5000);
            }

            loadInstitutions();
        } catch (error) {
            console.error("Error deleting institution:", error);
            const errorMessage = document.getElementById("errorMessage");
            errorMessage.textContent = "Terjadi kesalahan saat menghapus institusi.";
            errorMessage.classList.remove("d-none");
            setTimeout(() => errorMessage.classList.add("d-none"), 5000);
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        loadInstitutions();
    });
</script>