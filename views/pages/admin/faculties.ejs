<style>
    .table-responsive {
        overflow-x: auto;
    }
</style>
<div id="faculties" class="content-section active">
    <div class="page-header d-flex justify-content-between align-items-center">
        <div>
            <h2><i class="fas fa-university me-2"></i>Manajemen Fakultas</h2>
            <p class="text-muted mb-0">Kelola data fakultas</p>
        </div>
        <button class="btn btn-primary" onclick="showFacultyModal()">
            <i class="fas fa-plus me-2"></i>Tambah Fakultas
        </button>
    </div>

    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Daftar Fakultas</h5>
        </div>
        <div class="card-body">
            <div id="errorMessage" class="alert alert-danger d-none"></div>
            <div id="successMessage" class="alert alert-success d-none"></div>
            <div class="div table-responsive">
            <table class="table table-striped table-hover" id="facultiesTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nama Fakultas</th>
                        <th>Status</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Faculty -->
<div class="modal fade" id="facultyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="facultyForm" onsubmit="event.preventDefault(); saveFaculty();">
                <div class="modal-header">
                    <h5 class="modal-title" id="facultyModalTitle">Tambah Fakultas</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="facultyId" />
                    <div id="errorMessageModal" class="alert alert-danger d-none"></div>
                    <div class="mb-3">
                        <label for="facultyName" class="form-label">Nama Fakultas</label>
                        <input type="text" class="form-control" id="facultyName" required />
                    </div>
                    <div class="mb-3">
                        <label for="facultyActive" class="form-label">Status</label>
                        <select class="form-select" id="facultyActive" required>
                            <option value="">Pilih Status</option>
                            <option value="aktif">Aktif</option>
                            <option value="nonaktif">Non-Aktif</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Jquery CDN -->
<script
 src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
 integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
 crossorigin="anonymous"
 referrerpolicy="no-referrer"></script>
<!-- DataTables CSS -->
<link
 rel="stylesheet"
 href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" />

<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>


<script>
    let faculties = [];
    let dataTable;

    function renderDataTable() {
        // Destroy existing DataTable if it exists
        if (dataTable) {
            dataTable.destroy();
        }

        // Initialize DataTable
        dataTable = $("#facultiesTable").DataTable({
            data: faculties,
            columns: [
                { data: "id" },
                { data: "name" },
                {
                    data: "active",
                    render: function (data) {
                        return `<span class="badge bg-${data ? "success" : "danger"}">
                            ${data ? "Aktif" : "Non-Aktif"}
                        </span>`;
                    },
                },
                {
                    data: null,
                    render: function (data, type, row) {
                        return `
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editFaculty(${row.id})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteFaculty(${row.id})" title="Hapus">
                                <i class="fas fa-trash"></i>
                            </button>
                        `;
                    },
                    orderable: false,
                },
            ],
            order: [[0, "desc"]], // Sort by ID descending
            pageLength: 10,
            lengthMenu: [
                [5, 10, 25, 50, -1],
                [5, 10, 25, 50, "Semua"],
            ],
            language: {
                lengthMenu: "Tampilkan _MENU_ data per halaman",
                zeroRecords: "Data tidak ditemukan",
                info: "Menampilkan halaman _PAGE_ dari _PAGES_",
                infoEmpty: "Tidak ada data tersedia",
                infoFiltered: "(difilter dari _MAX_ total data)",
                search: "Cari:",
                paginate: {
                    first: "Pertama",
                    last: "Terakhir",
                    next: "Selanjutnya",
                    previous: "Sebelumnya",
                },
            },
            responsive: true,
            autoWidth: false,
        });
    }

    async function loadFaculties() {
        faculties = await fetchFaculties();
        renderDataTable();
    }

    async function fetchFaculties() {
        try {
            const response = await fetch("/api/faculties");
            if (!response.ok) throw new Error("Network response was not ok");
            return await response.json();
        } catch (error) {
            console.error("Error fetching faculties:", error);
            return [];
        }
    }

    function showFacultyModal(facultyId = null) {
        const modal = new bootstrap.Modal(document.getElementById("facultyModal"));
        const title = document.getElementById("facultyModalTitle");
        const form = document.getElementById("facultyForm");
        document.getElementById("errorMessageModal").classList.add("d-none");

        if (facultyId) {
            const faculty = faculties.find((f) => f.id === facultyId);
            title.textContent = "Edit Fakultas";
            document.getElementById("facultyId").value = faculty.id;
            document.getElementById("facultyName").value = faculty.name;
            document.getElementById("facultyActive").value = faculty.active ? "aktif" : "nonaktif";
        } else {
            title.textContent = "Tambah Fakultas";
            form.reset();
            document.getElementById("facultyId").value = "";
        }

        modal.show();
    }

    function editFaculty(facultyId) {
        showFacultyModal(facultyId);
    }

    async function saveFaculty() {
        const facultyId = document.getElementById("facultyId").value;
        const facultyData = {
            name: document.getElementById("facultyName").value.trim(),
            active: document.getElementById("facultyActive").value,
        };

        const invalidFields = Object.entries(facultyData).filter(([key, value]) => !value);
        if (invalidFields.length > 0) {
            const errorMessage = document.getElementById("errorMessageModal");
            errorMessage.textContent = `Field ${invalidFields
                .map(([key]) => key.replace("_", " "))
                .join(", ")} wajib diisi.`;
            errorMessage.classList.remove("d-none");
            return;
        }

        facultyData.active = facultyData.active === "aktif" ? true : false;

        try {
            const url = facultyId ? `/api/faculties/${facultyId}` : "/api/faculties";
            const method = facultyId ? "PUT" : "POST";

            const response = await fetch(url, {
                method: method,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(facultyData),
            });

            const json = await response.json();

            if (response.ok) {
                const successMessage = document.getElementById("successMessage");
                successMessage.textContent = facultyId
                    ? "Fakultas berhasil diperbarui."
                    : "Fakultas berhasil ditambahkan.";
                successMessage.classList.remove("d-none");
                setTimeout(() => successMessage.classList.add("d-none"), 5000);

                bootstrap.Modal.getInstance(document.getElementById("facultyModal")).hide();
                loadFaculties();
            } else {
                const errorMessage = document.getElementById("errorMessageModal");
                errorMessage.textContent = json.message || "Terjadi kesalahan saat menyimpan fakultas.";
                errorMessage.classList.remove("d-none");
            }
        } catch (error) {
            console.error("Error saving faculty:", error);
            const errorMessage = document.getElementById("errorMessageModal");
            errorMessage.textContent = "Terjadi kesalahan saat menyimpan fakultas.";
            errorMessage.classList.remove("d-none");
        }
    }

    async function deleteFaculty(facultyId) {
        const confirmDelete = confirm("Apakah Anda yakin ingin menghapus fakultas ini?");
        if (!confirmDelete) return;

        try {
            const response = await fetch(`/api/faculties/${facultyId}`, {
                method: "DELETE",
            });

            if (response.ok) {
                const successMessage = document.getElementById("successMessage");
                successMessage.textContent = "Fakultas berhasil dihapus.";
                successMessage.classList.remove("d-none");
                setTimeout(() => successMessage.classList.add("d-none"), 5000);
            } else {
                const json = await response.json();
                const errorMessage = document.getElementById("errorMessage");
                errorMessage.textContent = json.message || "Terjadi kesalahan saat menghapus fakultas.";
                errorMessage.classList.remove("d-none");
                setTimeout(() => errorMessage.classList.add("d-none"), 5000);
            }

            loadFaculties();
        } catch (error) {
            console.error("Error deleting faculty:", error);
            const errorMessage = document.getElementById("errorMessage");
            errorMessage.textContent = "Terjadi kesalahan saat menghapus fakultas.";
            errorMessage.classList.remove("d-none");
            setTimeout(() => errorMessage.classList.add("d-none"), 5000);
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        loadFaculties();
    });
</script>