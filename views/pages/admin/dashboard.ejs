<div
 id="dashboard"
 class="content-section active">
 <div class="page-header">
  <h2><i class="fas fa-tachometer-alt me-2"></i>Dashboard</h2>
  <p class="text-muted mb-0">Selamat datang di panel admin Gunadarma</p>
 </div>

 <div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
   <h5 class="mb-0">Pemberitahuan</h5>
   <% if (user.roleCode === "SYSADMIN" || user.roleCode === "ADMIN") { %>
   <a
    href="/notifications"
    class="btn btn-sm btn-primary">
    <i class="fas fa-cog me-1"></i> Kelola
   </a>
   <% } %>
  </div>
  <div
   class="card-body"
   id="notificationPanel">
   <!-- Notifications will be loaded here -->
   <div class="text-center py-3">
    <div
     class="spinner-border text-primary"
     role="status">
     <span class="visually-hidden">Loading...</span>
    </div>
   </div>
  </div>
 </div>

 <div class="stats-grid">
  <div class="stats-card">
   <div class="stats-number">Data Tidak Ditemukan</div>
   <div class="stats-label">Total Lembaga Internasional</div>
  </div>
  <div class="stats-card">
   <div class="stats-number">Data Tidak Ditemukan</div>
   <div class="stats-label">Total Lembaga Nasional</div>
  </div>
    <% if (user.roleCode==="SYSADMIN" || user.roleCode==="ADMIN" ) { %>
    <div class="stats-card">
    <div class="stats-number">Data Tidak Ditemukan</div>
    <div class="stats-label">Total Progam Studi</div>
    </div>
    <% } %>
  <div class="stats-card">
   <div class="stats-number">Data Tidak Ditemukan</div>
   <div class="stats-label">Total Lembaga</div>
  </div>
  <div class="stats-card">
   <div class="stats-number">Data Tidak Ditemukan</div>
   <div class="stats-label">Total Akreditasi</div>
  </div>
 </div>
 <% if (user.roleCode==="SYSADMIN" || user.roleCode==="ADMIN" ) { %>
 <div class="card">
  <div class="card-header">
   <h5 class="mb-0">Program Studi yang Belum Terakreditasi</h5>
  </div>
  <div class="card-body">
   <div class="div table-responsive">
    <table
     class="table table-striped table-hover"
     id="unaccreditedMajorsTable">
     <thead>
      <tr>
       <th>No</th>
       <th>Nama Program Studi</th>
       <th>Fakultas</th>
      </tr>
     </thead>
     <tbody></tbody>
    </table>
   </div>
  </div>
 </div>
 <% } %>
 <div class="card">
  <div class="card-header">
   <h5 class="mb-0">Aktivitas Terbaru</h5>
  </div>
  <div class="card-body">
   <div class="table-responsive">
    <table
     class="table table-striped table-hover"
     id="activityLogTable">
     <thead>
      <tr>
       <th>Waktu</th>
       <th>Aktivitas</th>
       <th>User</th>
      </tr>
     </thead>
     <tbody></tbody>
    </table>
   </div>
  </div>
 </div>
</div>

<!-- Jquery CDN -->
<script
 src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
 integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
 crossorigin="anonymous"
 referrerpolicy="no-referrer"></script>
<!-- DataTables CSS -->
<link
 rel="stylesheet"
 href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" />

<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

<script>
 let unaccreditedMajorsTable;
 let activityLogTable;

 async function fetchDashboard() {
  try {
   const response = await fetch('/api/dashboard');
   if (!response.ok) throw new Error('Network response was not ok');
   return await response.json();
  } catch (error) {
   console.error('Error fetching dashboard data:', error);
   return null;
  }
 }

 async function loadDashboard() {
  const data = await fetchDashboard();
  if (!data) return;

  // Update statistics
  document.querySelector(
   '#dashboard .stats-card:nth-child(1) .stats-number'
  ).textContent = data.institutionInternationalCount;
  document.querySelector(
   '#dashboard .stats-card:nth-child(2) .stats-number'
  ).textContent = data.institutionNationalCount;
  document.querySelector(
   '#dashboard .stats-card:nth-child(3) .stats-number'
  ).textContent = data.majorCount;
  document.querySelector(
   '#dashboard .stats-card:nth-child(4) .stats-number'
  ).textContent = data.institutionCount;
  document.querySelector(
   '#dashboard .stats-card:nth-child(5) .stats-number'
  ).textContent = data.accreditationCount;

  // Load activity logs into DataTable
  loadActivityLogs(data.logs);
 }

 function loadActivityLogs(logs) {
  // Destroy existing DataTable if it exists
  if (activityLogTable) {
   activityLogTable.destroy();
  }

  // Transform logs data with row numbers
  const logsWithNumbers = logs.map((log, index) => ({
   ...log,
   rowNumber: index + 1,
  }));

  // Initialize DataTable for activity logs
  activityLogTable = $('#activityLogTable').DataTable({
   data: logsWithNumbers,
   columns: [
    {
     data: 'created_on',
     render: function (data) {
      return new Date(data).toLocaleString('id-ID', {
       day: '2-digit',
       month: '2-digit',
       year: 'numeric',
       hour: '2-digit',
       minute: '2-digit',
      });
     },
    },
    { data: 'action' },
    {
     data: null,
     render: function (data, type, row) {
      return row.user ? row.user.username : 'Unknown';
     },
    },
   ],
   order: [[0, 'desc']], // Sort by time descending
   pageLength: 10,
   lengthMenu: [
    [5, 10, 25, 50],
    [5, 10, 25, 50],
   ],
   language: {
    lengthMenu: 'Tampilkan _MENU_ data per halaman',
    zeroRecords: 'Tidak ada aktivitas',
    info: 'Menampilkan halaman _PAGE_ dari _PAGES_',
    infoEmpty: 'Tidak ada data tersedia',
    infoFiltered: '(difilter dari _MAX_ total data)',
    search: 'Cari:',
    paginate: {
     first: 'Pertama',
     last: 'Terakhir',
     next: 'Selanjutnya',
     previous: 'Sebelumnya',
    },
   },
   responsive: true,
   autoWidth: false,
  });
 }

 // Load active notifications
 async function loadActiveNotifications() {
  try {
   const response = await fetch('/api/notifications/active');
   if (!response.ok) throw new Error('Failed to load notifications');

   const notifications = await response.json();
   const panel = document.getElementById('notificationPanel');

   if (notifications.length === 0) {
    panel.innerHTML = `
                    <div class="alert alert-light mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Tidak ada pemberitahuan aktif saat ini.
                    </div>
                `;
    return;
   }

   panel.innerHTML = notifications
    .map((notification) => {
     let alertClass = 'alert-info';
     let icon = 'fa-info-circle';

     // Determine alert style based on type
     if (notification.type === 'expiring-accreditation') {
      alertClass = 'alert-warning';
      icon = 'fa-exclamation-triangle';

      // Show list of expiring accreditations if available
      let additionalInfo = '';
      if (notification.data && notification.data.accreditations) {
       const accList = notification.data.accreditations
        .slice(0, 3)
        .map(
         (acc) => `
                                <li>
                                    <strong>${acc.code}</strong> - ${acc.name} 
                                    (Kadaluarsa: ${acc.expired_on})
                                </li>
                            `
        )
        .join('');

       additionalInfo = `
                            <div class="mt-2">
                                <small class="d-block mb-1">Akreditasi yang akan berakhir:</small>
                                <ul class="mb-0 small">${accList}</ul>
                                ${
                                 notification.data.accreditations.length > 3
                                  ? `<small class="text-muted">...dan ${
                                     notification.data.accreditations.length - 3
                                    } lainnya</small>`
                                  : ''
                                }
                            </div>
                        `;
      }

      return `
                        <div class="alert ${alertClass} mb-3">
                            <div class="d-flex align-items-start">
                                <i class="fas ${icon} me-3 mt-1"></i>
                                <div class="flex-grow-1">
                                    <strong>${notification.title}</strong><br/>
                                    ${notification.description}
                                    ${additionalInfo}
                                </div>
                            </div>
                        </div>
                    `;
     } else if (
      notification.type === 'daily' ||
      notification.type === 'weekly' ||
      notification.type === 'monthly' ||
      notification.type === 'yearly'
     ) {
      alertClass = 'alert-primary';
      icon = 'fa-bell';
     }

     return `
                    <div class="alert ${alertClass} mb-3">
                        <div class="d-flex align-items-start">
                            <i class="fas ${icon} me-3 mt-1"></i>
                            <div class="flex-grow-1">
                                <strong>${notification.title}</strong><br/>
                                ${notification.description || ''}
                                ${
                                 notification.image
                                  ? `<img src="${notification.image}" class="img-fluid mt-2" style="max-height: 200px;">`
                                  : ''
                                }
                            </div>
                        </div>
                    </div>
                `;
    })
    .join('');
  } catch (error) {
   console.error('Error loading notifications:', error);
   document.getElementById('notificationPanel').innerHTML = `
                <div class="alert alert-danger mb-0">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Gagal memuat pemberitahuan.
                </div>
            `;
  }
 }

 // Fetch unaccredited major data
 async function loadUnaccreditedMajors() {
  try {
   const response = await fetch('/api/accreditations/majors');
   const majors = await response.json();

   if (response.ok) {
    // Destroy existing DataTable if it exists
    if (unaccreditedMajorsTable) {
     unaccreditedMajorsTable.destroy();
    }

    // Add row numbers to majors
    const majorsWithNumbers = majors.map((major, index) => ({
     ...major,
     rowNumber: index + 1,
    }));

    // Initialize DataTable for unaccredited majors
    unaccreditedMajorsTable = $('#unaccreditedMajorsTable').DataTable({
     data: majorsWithNumbers,
     columns: [
      { data: 'rowNumber' },
      { data: 'name' },
      {
       data: null,
       render: function (data, type, row) {
        return row.faculty?.name || '-';
       },
      },
     ],
     order: [[1, 'asc']], // Sort by name ascending
     pageLength: 10,
     lengthMenu: [
      [5, 10, 25, 50],
      [5, 10, 25, 50],
     ],
     language: {
      lengthMenu: 'Tampilkan _MENU_ data per halaman',
      zeroRecords: 'Semua Program Studi sudah terakreditasi',
      info: 'Menampilkan halaman _PAGE_ dari _PAGES_',
      infoEmpty: 'Tidak ada data tersedia',
      infoFiltered: '(difilter dari _MAX_ total data)',
      search: 'Cari:',
      paginate: {
       first: 'Pertama',
       last: 'Terakhir',
       next: 'Selanjutnya',
       previous: 'Sebelumnya',
      },
     },
     responsive: true,
     autoWidth: false,
    });
   } else {
    console.error('Error loading unaccredited majors:', majors);
   }
  } catch (error) {
   console.error('Error loading unaccredited majors:', error);
  }
 }

 // Update existing DOMContentLoaded listener
 document.addEventListener('DOMContentLoaded', function () {
  loadDashboard();
  loadActiveNotifications();
  loadUnaccreditedMajors();
 });

 // Refresh notifications every 5 minutes
 setInterval(loadActiveNotifications, 5 * 60 * 1000);
</script>

<!-- CSS Styles -->
<style>
 .alert {
  border-left: 4px solid;
  border-radius: 8px;
 }

 .alert-warning {
  border-left-color: #f59e0b;
  background-color: #fef3c7;
 }

 .alert-primary {
  border-left-color: #3b82f6;
  background-color: #eff6ff;
 }

 .alert-info {
  border-left-color: #06b6d4;
  background-color: #ecfeff;
 }

 .card-header .btn-sm {
  padding: 0.25rem 0.75rem;
  font-size: 0.875rem;
 }

 .stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin-bottom: 2rem;
 }

 .stats-card {
  background: white;
  padding: 1.5rem;
  border-radius: 8px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
 }

 .stats-number {
  font-size: 2rem;
  font-weight: bold;
  color: #3b82f6;
 }

 .stats-label {
  color: #6b7280;
  margin-top: 0.5rem;
  font-size: 0.875rem;
 }
 .table-responsive {
  overflow-x: auto;
 }
</style>
